---
# Claude Code
- name: Check if claude is installed
  ansible.builtin.shell:
    cmd: "command -v claude"
  register: claude_check
  changed_when: false
  failed_when: false
  check_mode: false
  tags:
    - install
    - claude

- name: Install Claude Code (native)
  ansible.builtin.shell:
    cmd: "curl -fsSL https://claude.ai/install.sh | bash"
  when: claude_check.rc != 0
  tags:
    - install
    - claude

- name: Install skills CLI via npx
  ansible.builtin.shell:
    cmd: "npm install -g skills"
  register: skills_install
  changed_when: true
  tags: skills

# Skills
- name: Install skills globally
  ansible.builtin.shell:
    cmd: "skills add {{ item }} -g -y"
  loop:
    - "anthropics/skills@skill-creator"
    - "softaworks/agent-toolkit@mermaid-diagrams"
    - "softaworks/agent-toolkit@humanizer"
    - "wshobson/agents@uv-package-manager"
    - "subsy/ralph-tui@ralph-tui-create-beads-rust"
    - "subsy/ralph-tui@ralph-tui-create-beads"
    - "subsy/ralph-tui@ralph-tui-create-json"
    - "subsy/ralph-tui@ralph-tui-prd"
  tags:
    - skills

# MCP Servers
- name: Set mcp_server_list for Fedora
  ansible.builtin.set_fact:
    mcp_server_list: "{{ mcp_servers | default([]) + fedora_mcp_servers | default([]) }}"
  when: ansible_distribution == "Fedora"
  tags:
    - mcp
    - config

- name: Set mcp_server_list for macOS
  ansible.builtin.set_fact:
    mcp_server_list: "{{ mcp_servers | default([]) + mac_mcp_servers | default([]) }}"
  when: ansible_distribution == "MacOSX"
  tags:
    - mcp
    - config

- name: Check for configured MCP servers
  ansible.builtin.shell:
    cmd: "claude mcp get {{ item.name }}"
  register: mcp_check_results
  loop: "{{ mcp_server_list }}"
  loop_control:
    label: "{{ item.name }}"
  when: mcp_server_list is defined and mcp_server_list | length > 0
  changed_when: false
  failed_when: false
  check_mode: false
  tags:
    - mcp
    - config

- name: Add stdio MCP servers
  ansible.builtin.shell:
    cmd: "claude mcp add {{ item.item.name }} -s user {% if item.item.env is defined %}{% for key, value in item.item.env.items() %}-e {{ key }}='{{ value }}' {% endfor %}{% endif %}-- {{ item.item.command }}"
  loop: "{{ mcp_check_results.results | default([]) }}"
  loop_control:
    label: "{{ item.item.name }}"
  when:
    - item.rc != 0
    - item.item.transport is not defined or item.item.transport == 'stdio'
  tags:
    - mcp
    - config

- name: Add sse/http MCP servers
  ansible.builtin.shell:
    cmd: "claude mcp add --transport {{ item.item.transport }} {{ item.item.name }} {{ item.item.url }} -s user {% if item.item.env is defined %}{% for key, value in item.item.env.items() %}-e {{ key }}='{{ value }}' {% endfor %}{% endif %} {% if item.item.headers is defined %}{% for key, value in item.item.headers.items() %}-H '{{ key }}:{{ value }}' {% endfor %}{% endif %}"
  loop: "{{ mcp_check_results.results | default([]) }}"
  loop_control:
    label: "{{ item.item.name }}"
  when:
    - item.rc != 0
    - item.item.transport is defined and (item.item.transport == 'sse' or item.item.transport == 'http')
  tags:
    - mcp
    - config
